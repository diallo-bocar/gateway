#!/usr/bin/env node
import{serve as e}from"@hono/node-server";import{Hono as t}from"hono";import{prettyJSON as a}from"hono/pretty-json";import{HTTPException as r}from"hono/http-exception";import{SignatureV4 as o}from"@smithy/signature-v4";import{Sha256 as n}from"@aws-crypto/sha256-js";import s from"async-retry";import{env as i,getRuntimeKey as p}from"hono/adapter";import{z as m}from"zod";import{compress as c}from"hono/compress";const l="portkey",d={MODE:`x-${l}-mode`,RETRIES:`x-${l}-retry-count`,PROVIDER:`x-${l}-provider`,TRACE_ID:`x-${l}-trace-id`,CACHE:`x-${l}-cache`,FORWARD_HEADERS:`x-${l}-forward-headers`,CUSTOM_HOST:`x-${l}-custom-host`},u={RETRY_ATTEMPT_COUNT:`x-${l}-retry-attempt-count`,LAST_USED_OPTION_INDEX:`x-${l}-last-used-option-index`,LAST_USED_OPTION_PARAMS:`x-${l}-last-used-option-params`,CACHE_STATUS:`x-${l}-cache-status`,TRACE_ID:`x-${l}-trace-id`},f=[429,500,502,503,504],g=408,h="openai",_="cohere",y="azure-openai",x="anthropic",b="anyscale",k="palm",v="together-ai",w="google",O="perplexity-ai",q="mistral-ai",T="deepinfra",C="stability-ai",S="nomic",j="ollama",$="ai21",N="bedrock",E="groq",R="segmind",A=[x,b,y,_,w,q,h,k,O,v,T,C,S,j,$,N,E,R],D={APPLICATION_JSON:"application/json",MULTIPART_FORM_DATA:"multipart/form-data",EVENT_STREAM:"text/event-stream",AUDIO_MPEG:"audio/mpeg",APPLICATION_OCTET_STREAM:"application/octet-stream",GENERIC_AUDIO_PATTERN:"audio",PLAIN_TEXT:"text/plain",HTML:"text/html",GENERIC_IMAGE_PATTERN:"image/"},M=(e,t)=>({error:{message:`Invalid response recieved from ${t}: ${JSON.stringify(e)}`,type:null,param:null,code:null},provider:t}),P=({message:e,type:t,param:a,code:r},o)=>({error:{message:`${o} error: ${e}`,type:t??null,param:a??null,code:r??null},provider:o}),J=e=>{if("detail"in e)return P({message:e.detail,type:null,param:null,code:null},$)},I=e=>{if("error"in e)return P({message:e.error?.message,type:e.error?.type,param:null,code:null},x)},B=e=>{if("detail"in e&&e.detail.length){let t,a,r=null,o=null;return Array.isArray(e.detail)?([t]=e.detail,r=t?.loc?.join(".")??"",a=t.msg,o=t.type):a=e.detail,P({message:`${r?`${r}: `:""}${a}`,type:o,param:null,code:null},b)}if("error"in e)return P({message:e.error?.message,type:e.error?.type,param:null,code:null},b)},z=(e,t)=>P({...e.error},t),U=(e,t)=>{const a=[],{id:r,model:o,system_fingerprint:n,choices:s}=e,{prompt_tokens:i,completion_tokens:p}=e.usage||{};let m;i&&p&&(m=i+p);const c={id:r,object:"chat.completion.chunk",created:Date.now(),model:o||"",system_fingerprint:n||null,provider:t,usage:{...p&&{completion_tokens:p},...i&&{prompt_tokens:i},...m&&{total_tokens:m}}};for(const[e,t]of s.entries()){if(t.message&&t.message.tool_calls&&t.message.tool_calls.length)for(const[r,o]of t.message.tool_calls.entries()){const t={index:r,id:o.id,type:"function",function:{name:o.function.name,arguments:""}},n={index:r,function:{arguments:o.function.arguments}};a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{role:"assistant",content:null,tool_calls:[t]}}]})}\n\n`),a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{role:"assistant",tool_calls:[n]}}]})}\n\n`)}if(t.message&&t.message.content&&"string"==typeof t.message.content){const r=[];for(let e=0;e<t.message.content.length;e+=4)r.push(t.message.content.slice(e,e+4));r.forEach((t=>{a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{role:"assistant",content:t}}]})}\n\n`)}))}a.push(`data: ${JSON.stringify({...c,choices:[{index:e,delta:{},finish_reason:t.finish_reason}]})}\n\n`)}return a.push("data: [DONE]\n\n"),a},L={getBaseURL:({providerOptions:e})=>`https://bedrock-runtime.${e.awsRegion||"us-east-1"}.amazonaws.com`,headers:async({providerOptions:e,transformedRequestBody:t,transformedRequestUrl:a})=>(async(e,t,a,r,s,i,p,m,c)=>{const l=new o({service:s,region:i||"us-east-1",credentials:{accessKeyId:p,secretAccessKey:m,...c&&{sessionToken:c}},sha256:n}),d=new URL(a),u=d.hostname;t.host=u;const f={method:r,path:d.pathname,protocol:"https",hostname:d.hostname,headers:t,body:JSON.stringify(e)};return(await l.sign(f)).headers})(t,{"content-type":"application/json"},a,"POST","bedrock",e.awsRegion||"",e.awsAccessKeyId||"",e.awsSecretAccessKey||"",e.awsSessionToken||""),getEndpoint:({fn:e,gatewayRequestBody:t})=>{const{model:a,stream:r}=t;let o=e;r&&(o=`stream-${e}`);const n=`/model/${a}/invoke`,s=`/model/${a}/invoke-with-response-stream`;switch(o){case"chatComplete":case"complete":case"embed":case"imageGenerate":return n;case"stream-chatComplete":case"stream-complete":return s;default:return""}}},H={messages:[{param:"messages",required:!0,transform:e=>{let t=[];return e.messages&&e.messages.forEach((e=>{if("system"!==e.role)if(e.content&&"object"==typeof e.content&&e.content.length){const a={role:e.role,content:[]};e.content.forEach((e=>{if("text"===e.type)a.content.push({type:e.type,text:e.text});else if("image_url"===e.type&&e.image_url&&e.image_url.url){const t=e.image_url.url.split(";");if(2===t.length){const e=t[1].split(",")[1],r=t[0].split(":");if(2===r.length&&e){const t=r[1];a.content.push({type:"image",source:{type:"base64",media_type:t,data:e}})}}}})),t.push(a)}else t.push({role:e.role,content:e.content})})),t}},{param:"system",required:!1,transform:e=>{let t="";return e.messages&&e.messages.forEach((e=>{"system"===e.role&&e.content&&"object"==typeof e.content&&e.content[0].text?t=e.content[0].text:"system"===e.role&&"string"==typeof e.content&&(t=e.content)})),t}}],max_tokens:{param:"max_tokens",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences",transform:e=>null===e.stop?[]:e.stop},user:{param:"metadata.user_id"},anthropic_version:{param:"anthropic_version",required:!0,default:"bedrock-2023-05-31"}},K={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,r)=>{0===r&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream"}},G={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,r)=>{0===r&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"max_gen_len",default:512,min:1,max:2048},temperature:{param:"temperature",default:.5,min:0,max:1},top_p:{param:"top_p",default:.9,min:0,max:1}},W=e=>{const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.max_tokens&&(t.maxTokenCount=e.max_tokens),e.stop&&(t.stopSequences=e.stop),t},F={messages:{param:"inputText",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,r)=>{0===r&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},temperature:{param:"textGenerationConfig",transform:e=>W(e)},max_tokens:{param:"textGenerationConfig",transform:e=>W(e)},top_p:{param:"textGenerationConfig",transform:e=>W(e)}},X={messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){let a=e.messages;a.forEach(((e,r)=>{0===r&&"system"===e.role?t+=`system: ${a}\n`:"user"==e.role?t+=`user: ${e.content}\n`:"assistant"==e.role?t+=`assistant: ${e.content}\n`:t+=`${e.role}: ${e.content}\n`})),t+="Assistant:"}return t}},max_tokens:{param:"maxTokens",default:200},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},V=e=>{if("message"in e)return P({message:e.message,type:null,param:null,code:null},N)},Y=(e,t)=>{if(200!==t){const t=V(e);if(t)return t}return"generation"in e?{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:0,message:{role:"assistant",content:e.generation},finish_reason:e.stop_reason}],usage:{prompt_tokens:e.prompt_token_count,completion_tokens:e.generation_token_count,total_tokens:e.prompt_token_count+e.generation_token_count}}:M(e,N)},Q=(e,t)=>{let a=e.trim();a=a.trim();const r=JSON.parse(a);return r.stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{delta:{},index:0,logprobs:null,finish_reason:r.stop_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:0,delta:{role:"assistant",content:r.generation},finish_reason:null}]})}\n\n`},Z=(e,t)=>{if(200!==t){const t=V(e);if(t)return t}if("results"in e){const t=e.results.map((e=>e.tokenCount)).reduce(((e,t)=>e+t),0);return{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.results.map(((e,t)=>({index:t,message:{role:"assistant",content:e.outputText},finish_reason:e.completionReason}))),usage:{prompt_tokens:e.inputTextTokenCount,completion_tokens:t,total_tokens:e.inputTextTokenCount+t}}}return M(e,N)},ee=(e,t)=>{let a=e.trim();a=a.trim();const r=JSON.parse(a);return[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:0,delta:{role:"assistant",content:r.outputText},finish_reason:null}]})}\n\n`,`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:0,delta:{},finish_reason:r.completionReason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]},te=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}if("completions"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,r=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id.toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.completions.map(((e,t)=>({index:t,message:{role:"assistant",content:e.data.text},finish_reason:e.finishReason?.reason}))),usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}}return M(e,N)},ae=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}if("content"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,r=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id,object:"chat.completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:N,choices:[{message:{role:"assistant",content:e.content[0].text},index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}}return M(e,N)},re=(e,t)=>{let a=e.trim();const r=JSON.parse(a);return"ping"===r.type||"message_start"===r.type||"content_block_start"===r.type||"content_block_stop"===r.type?[]:"message_stop"===r.type?[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:0,delta:{},finish_reason:r.delta?.stop_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:r.delta?.stop_reason?[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{delta:{content:r.delta?.text},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`]:`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{delta:{content:r.delta?.text},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`},oe=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}if("generations"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,r=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:Date.now().toString(),object:"chat.completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.generations.map(((e,t)=>({index:t,message:{role:"assistant",content:e.text},finish_reason:e.finish_reason}))),usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}}return M(e,N)},ne=(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const r=JSON.parse(a);return r.is_finished?[`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:r.index??0,delta:{},finish_reason:r.finish_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{index:r.index??0,delta:{role:"assistant",content:r.text},finish_reason:null}]})}\n\n`},se={prompt:{param:"prompt",transform:e=>`\n\nHuman: ${e.prompt}\n\nAssistant:`,required:!0},max_tokens:{param:"max_tokens_to_sample",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences",transform:e=>null===e.stop?[]:e.stop},user:{param:"metadata.user_id"}},ie={prompt:{param:"prompt",required:!0},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream"}},pe={prompt:{param:"prompt",required:!0},max_tokens:{param:"max_gen_len",default:512,min:1,max:2048},temperature:{param:"temperature",default:.5,min:0,max:1},top_p:{param:"top_p",default:.9,min:0,max:1}},me=e=>{const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.max_tokens&&(t.maxTokenCount=e.max_tokens),e.stop&&(t.stopSequences=e.stop),t},ce={prompt:{param:"inputText",required:!0},temperature:{param:"textGenerationConfig",transform:e=>me(e)},max_tokens:{param:"textGenerationConfig",transform:e=>me(e)},top_p:{param:"textGenerationConfig",transform:e=>me(e)}},le={prompt:{param:"prompt",required:!0},max_tokens:{param:"maxTokens",default:200},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},de=(e,t)=>{if(200!==t){const t=V(e);if(t)return t}return"generation"in e?{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:e.generation,index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:e.prompt_token_count,completion_tokens:e.generation_token_count,total_tokens:e.prompt_token_count+e.generation_token_count}}:M(e,N)},ue=(e,t)=>{let a=e.trim();a=a.trim();const r=JSON.parse(a);return r.stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:"",index:0,logprobs:null,finish_reason:r.stop_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:r.generation,index:0,logprobs:null,finish_reason:null}]})}\n\n`},fe=(e,t)=>{if(200!==t){const t=V(e);if(t)return t}if("results"in e){const t=e.results.map((e=>e.tokenCount)).reduce(((e,t)=>e+t),0);return{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.results.map(((e,t)=>({text:e.outputText,index:t,logprobs:null,finish_reason:e.completionReason}))),usage:{prompt_tokens:e.inputTextTokenCount,completion_tokens:t,total_tokens:e.inputTextTokenCount+t}}}return M(e,N)},ge=(e,t)=>{let a=e.trim();a=a.trim();const r=JSON.parse(a);return[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:r.outputText,index:0,logprobs:null,finish_reason:null}]})}\n\n`,`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:"",index:0,logprobs:null,finish_reason:r.completionReason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]},he=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}if("completions"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,r=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id.toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.completions.map(((e,t)=>({text:e.data.text,index:t,logprobs:null,finish_reason:e.finishReason?.reason}))),usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}}return M(e,N)},_e=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}if("completion"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,r=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:Date.now().toString(),object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:e.completion,index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}}return M(e,N)},ye=(e,t)=>{let a=e.trim();const r=JSON.parse(a);return r.stop_reason?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:r.completion,index:0,logprobs:null,finish_reason:null}]})}\n\n`,`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:"",index:0,logprobs:null,finish_reason:r.stop_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:r.completion,index:0,logprobs:null,finish_reason:null}]})}\n\n`},xe=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}if("generations"in e){const t=Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||0,r=Number(a.get("X-Amzn-Bedrock-Output-Token-Count"))||0;return{id:e.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:e.generations.map(((e,t)=>({text:e.text,index:t,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}}return M(e,N)},be=(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const r=JSON.parse(a);return r.is_finished?[`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:"",index:0,logprobs:null,finish_reason:r.finish_reason}],usage:{prompt_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount,completion_tokens:r["amazon-bedrock-invocationMetrics"].outputTokenCount,total_tokens:r["amazon-bedrock-invocationMetrics"].inputTokenCount+r["amazon-bedrock-invocationMetrics"].outputTokenCount}})}\n\n`,"data: [DONE]\n\n"]:`data: ${JSON.stringify({id:t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:N,choices:[{text:r.text,index:r.index??0,logprobs:null,finish_reason:null}]})}\n\n`},ke={input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},input_type:{param:"input_type",required:!0},truncate:{param:"truncate"}},ve={input:{param:"inputText",required:!0}},we=(e,t)=>{if(200!==t){const t=V(e);if(t)return t}return"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding,index:0}],provider:N,model:"",usage:{prompt_tokens:e.inputTextTokenCount,total_tokens:e.inputTextTokenCount}}:M(e,N)},Oe=(e,t,a)=>{if(200!==t){const t=V(e);if(t)return t}return"embeddings"in e?{object:"list",data:e.embeddings.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),provider:N,model:"",usage:{prompt_tokens:Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||-1,total_tokens:Number(a.get("X-Amzn-Bedrock-Input-Token-Count"))||-1}}:M(e,N)},qe={prompt:{param:"text_prompts",required:!0,transform:e=>[{text:e.prompt,weight:1}]},n:{param:"samples",min:1,max:10},size:[{param:"height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1]),min:320},{param:"width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0]),min:320}],style:{param:"style_preset"}},Te=(e,t)=>{if(200!==t){const t=V(e);if(t)return t}return"artifacts"in e?{created:`${(new Date).getTime()}`,data:e.artifacts.map((e=>({b64_json:e.base64}))),provider:N}:M(e,N)},Ce=e=>{const t={};return e.temperature&&(t.temperature=e.temperature),e.top_p&&(t.topP=e.top_p),e.top_k&&(t.topK=e.top_k),e.max_tokens&&(t.maxOutputTokens=e.max_tokens),e.stop&&(t.stopSequences=e.stop),t},Se=(e,t=w)=>{if("error"in e)return P({message:e.error.message??"",type:e.error.status??null,param:null,code:e.error.status??null},t)},je=(e,t)=>{const a=[],{id:r,model:o,choices:n}=e,{prompt_tokens:s,completion_tokens:i}=e.usage||{};let p;s&&i&&(p=s+i);const m={id:r,object:"text_completion",created:Date.now(),model:o??"",provider:t,usage:{...i&&{completion_tokens:i},...s&&{prompt_tokens:s},...p&&{total_tokens:p}}};for(const[e,t]of n.entries()){if(t.text){const r=[];for(let e=0;e<t.text.length;e+=4)r.push(t.text.slice(e,e+4));r.forEach((t=>{a.push(`data: ${JSON.stringify({...m,choices:[{index:e,text:t}]})}\n\n`)}))}a.push(`data: ${JSON.stringify({...m,choices:[{index:e,text:"",finish_reason:t.finish_reason}]})}\n\n`)}return a.push("data: [DONE]\n\n"),a},$e=e=>"error"in e&&"string"==typeof e.error?P({message:e.error,type:null,param:null,code:null},v):"error"in e&&"object"==typeof e.error?P({message:e.error?.message||"",type:e.error?.type||null,param:e.error?.param||null,code:e.error?.code||null},v):!(!("message"in e)||!e.message)&&P({message:e.message,type:e.type||null,param:null,code:null},v),Ne={openai:{complete:{model:{param:"model",required:!0,default:"text-davinci-003"},prompt:{param:"prompt",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},logprobs:{param:"logprobs",max:5},echo:{param:"echo",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},best_of:{param:"best_of"},logit_bias:{param:"logit_bias"},user:{param:"user"},seed:{param:"seed"},suffix:{param:"suffix"}},embed:{model:{param:"model",required:!0,default:"text-embedding-ada-002"},input:{param:"input",required:!0},encoding_format:{param:"encoding_format"},dimensions:{param:"dimensions"},user:{param:"user"}},api:{getBaseURL:()=>"https://api.openai.com/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"complete":return"/completions";case"chatComplete":return"/chat/completions";case"embed":return"/embeddings";case"imageGenerate":return"/images/generations";default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"gpt-3.5-turbo"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},seed:{param:"seed"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"},logprobs:{param:"logprobs",default:!1},top_logprobs:{param:"top_logprobs"}},imageGenerate:{prompt:{param:"prompt",required:!0},model:{param:"model",required:!0,default:"dall-e-2"},n:{param:"n",min:1,max:10},quality:{param:"quality"},response_format:{param:"response_format"},size:{param:"size"},style:{param:"style"},user:{param:"user"}},responseTransforms:{complete:(e,t)=>200!==t&&"error"in e?z(e,h):e,chatComplete:(e,t)=>200!==t&&"error"in e?z(e,h):e,embed:(e,t)=>200!==t&&"error"in e?z(e,h):e,imageGenerate:(e,t)=>200!==t&&"error"in e?z(e,h):e}},cohere:{complete:{model:{param:"model",default:"command",required:!0},prompt:{param:"prompt",required:!0},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream",default:!1}},chatComplete:{model:{param:"model",default:"command",required:!0},messages:{param:"prompt",required:!0,transform:e=>{let t="";if(e.messages){e.messages.forEach((e=>{t+=`${e.role}:${e.content}\n`})),t=t.trim()}return t}},max_tokens:{param:"max_tokens",default:20,min:1},temperature:{param:"temperature",default:.75,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},presence_penalty:{param:"presence_penalty",default:0,min:0,max:1},logit_bias:{param:"logit_bias"},n:{param:"num_generations",default:1,min:1,max:5},stop:{param:"end_sequences"},stream:{param:"stream",default:!1}},embed:{input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},model:{param:"model",default:"embed-english-light-v2.0"}},api:{getBaseURL:()=>"https://api.cohere.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":case"complete":return"/generate";case"embed":return"/embed";default:return""}}},responseTransforms:{complete:(e,t)=>200!==t?P({message:e.message||"",type:null,param:null,code:null},_):{id:e.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:_,choices:e.generations.map(((e,t)=>({text:e.text,index:t,logprobs:null,finish_reason:"length"})))},"stream-complete":(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const r=JSON.parse(a);return r.is_finished?"":`data: ${JSON.stringify({id:r.id??t,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:_,choices:[{text:r.response?.generations?.[0]?.text??r.text,index:r.index??0,logprobs:null,finish_reason:r.response?.generations?.[0]?.finish_reason??null}]})}\n\n`},chatComplete:(e,t)=>200!==t?P({message:e.message||"",type:null,param:null,code:null},_):{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:_,choices:e.generations.map(((e,t)=>({message:{role:"assistant",content:e.text},index:t,finish_reason:"length"})))},"stream-chatComplete":(e,t)=>{let a=e.trim();a=a.replace(/^data: /,""),a=a.trim();const r=JSON.parse(a);return r.is_finished?"":`data: ${JSON.stringify({id:r.id??t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:_,choices:[{delta:{content:r.response?.generations?.[0]?.text??r.text},index:r.index??0,logprobs:null,finish_reason:r.response?.generations?.[0]?.finish_reason??null}]})}\n\n`},embed:(e,t)=>200!==t?P({message:e.message||"",type:null,param:null,code:null},_):{object:"list",data:e.embeddings.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),model:"",usage:{prompt_tokens:-1,total_tokens:-1}}}},anthropic:{complete:{model:{param:"model",default:"claude-instant-1",required:!0},prompt:{param:"prompt",transform:e=>`\n\nHuman: ${e.prompt}\n\nAssistant:`,required:!0},max_tokens:{param:"max_tokens_to_sample",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences",transform:e=>null===e.stop?[]:e.stop},stream:{param:"stream",default:!1},user:{param:"metadata.user_id"}},chatComplete:{model:{param:"model",default:"claude-2.1",required:!0},messages:[{param:"messages",required:!0,transform:e=>{let t=[];return e.messages&&e.messages.forEach((e=>{if("system"!==e.role)if(e.content&&"object"==typeof e.content&&e.content.length){const a={role:e.role,content:[]};e.content.forEach((e=>{if("text"===e.type)a.content.push({type:e.type,text:e.text});else if("image_url"===e.type&&e.image_url&&e.image_url.url){const t=e.image_url.url.split(";");if(2===t.length){const e=t[1].split(",")[1],r=t[0].split(":");if(2===r.length&&e){const t=r[1];a.content.push({type:"image",source:{type:"base64",media_type:t,data:e}})}}}})),t.push(a)}else t.push({role:e.role,content:e.content})})),t}},{param:"system",required:!1,transform:e=>{let t="";return e.messages&&e.messages.forEach((e=>{"system"===e.role&&e.content&&"object"==typeof e.content&&e.content[0].text?t=e.content[0].text:"system"===e.role&&"string"==typeof e.content&&(t=e.content)})),t}}],max_tokens:{param:"max_tokens",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences"},stream:{param:"stream",default:!1},user:{param:"metadata.user_id"}},api:{getBaseURL:()=>"https://api.anthropic.com/v1",headers:({providerOptions:e,fn:t})=>{const a={"X-API-Key":`${e.apiKey}`,"anthropic-version":"2023-06-01"};return"chatComplete"===t&&(a["anthropic-beta"]="messages-2023-12-15"),a},getEndpoint:({fn:e})=>{switch(e){case"complete":return"/complete";case"chatComplete":return"/messages";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t.startsWith("event: ping"))return;if(t=t.replace(/^event: completion[\r\n]*/,""),t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return t;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.log_id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:a.model,provider:"anthropic",choices:[{text:a.completion,index:0,logprobs:null,finish_reason:a.stop_reason}]})}\n\n`},complete:(e,t)=>{if(200!==t){const t=I(e);if(t)return t}return"completion"in e?{id:e.log_id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:x,choices:[{text:e.completion,index:0,logprobs:null,finish_reason:e.stop_reason}]}:M(e,x)},chatComplete:(e,t)=>{if(200!==t){const t=I(e);if(t)return t}if("content"in e){const{input_tokens:t=0,output_tokens:a=0}=e?.usage;return{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:x,choices:[{message:{role:"assistant",content:e.content[0].text},index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:t,completion_tokens:a,total_tokens:t+a}}}return M(e,x)},"stream-chatComplete":(e,t)=>{let a=e.trim();if(a.startsWith("event: ping")||a.startsWith("event: message_start")||a.startsWith("event: content_block_start")||a.startsWith("event: content_block_stop"))return;if(a.startsWith("event: message_stop"))return"data: [DONE]\n\n";a=a.replace(/^event: content_block_delta[\r\n]*/,""),a=a.replace(/^event: message_delta[\r\n]*/,""),a=a.replace(/^data: /,""),a=a.trim();const r=JSON.parse(a);return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:x,choices:[{delta:{content:r.delta?.text},index:0,logprobs:null,finish_reason:r.delta?.stop_reason??null}]})}\n\n`}}},"azure-openai":{complete:{model:{param:"model"},prompt:{param:"prompt",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},logprobs:{param:"logprobs",max:5},echo:{param:"echo",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},best_of:{param:"best_of"},logit_bias:{param:"logit_bias"},user:{param:"user"}},embed:{model:{param:"model"},input:{param:"input",required:!0},user:{param:"user"}},api:{getBaseURL:({providerOptions:e})=>{const{resourceName:t,deploymentId:a}=e;return`https://${t}.openai.azure.com/openai/deployments/${a}`},headers:({providerOptions:e})=>{const{apiKey:t}=e;return{"api-key":`${t}`}},getEndpoint:({providerOptions:e,fn:t})=>{const{apiVersion:a,urlToFetch:r}=e;let o=t;switch("proxy"===t&&r&&r?.indexOf("/chat/completions")>-1?o="chatComplete":"proxy"===t&&r&&r?.indexOf("/completions")>-1?o="complete":"proxy"===t&&r&&r?.indexOf("/embeddings")>-1&&(o="embed"),o){case"complete":return`/completions?api-version=${a}`;case"chatComplete":return`/chat/completions?api-version=${a}`;case"embed":return`/embeddings?api-version=${a}`;default:return""}}},chatComplete:{model:{param:"model"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"}},responseTransforms:{complete:(e,t)=>200!==t&&"error"in e?z(e,y):e,chatComplete:(e,t)=>200!==t&&"error"in e?z(e,y):e,embed:(e,t)=>200!==t&&"error"in e?z(e,y):e}},anyscale:{complete:{model:{param:"model",required:!0,default:"Meta-Llama/Llama-Guard-7b"},prompt:{param:"prompt",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},logprobs:{param:"logprobs",max:5},echo:{param:"echo",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},best_of:{param:"best_of"},logit_bias:{param:"logit_bias"},user:{param:"user"}},chatComplete:{model:{param:"model",required:!0,default:"meta-llama/Llama-2-7b-chat-hf"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"},logprobs:{param:"logprobs",default:!1},top_logprobs:{param:"top_logprobs"}},embed:{model:{param:"model",required:!0,default:"thenlper/gte-large"},input:{param:"input",default:""},user:{param:"user"}},api:{getBaseURL:()=>"https://api.endpoints.anyscale.com/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":return"/chat/completions";case"complete":return"/completions";case"embed":return"/embeddings";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:b,choices:a.choices})}\n\n`},complete:(e,t)=>{if(200!==t){const t=B(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:b,choices:e.choices,usage:e.usage}:M(e,b)},chatComplete:(e,t)=>{if(200!==t){const t=B(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:b,choices:e.choices,usage:e.usage}:M(e,b)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:b,choices:a.choices})}\n\n`},embed:(e,t)=>{if(200!==t){const t=B(e);if(t)return t}return"data"in e?{object:e.object,data:e.data,model:e.model,usage:e.usage}:M(e,b)}}},palm:{complete:{model:{param:"model",required:!0,default:"model/text-bison-001"},prompt:{param:"prompt",default:"",transform:e=>{const{prompt:t}=e;return{text:t}}},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"topP",default:1,min:0,max:1},top_k:{param:"topK",default:1,min:0,max:1},n:{param:"candidateCount",default:1,min:1,max:8},max_tokens:{param:"maxOutputTokens",default:100,min:1},stop:{param:"stopSequences"}},embed:{input:{param:"text",required:!0},model:{param:"model",default:"models/embedding-gecko-001"}},api:{getBaseURL:()=>"https://generativelanguage.googleapis.com/v1beta3",headers:()=>({"Content-Type":"application/json"}),getEndpoint:({providerOptions:e,fn:t,gatewayRequestBody:a})=>{const{apiKey:r}=e,{model:o}=a;switch(t){case"complete":return`/models/${o}:generateText?key=${r}`;case"chatComplete":return`/models/${o}:generateMessage?key=${r}`;case"embed":return`/models/${o}:embedText?key=${r}`;default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"model/chat-bison-001"},messages:{param:"prompt",default:"",transform:e=>{const{examples:t,context:a,messages:r}=e,o=r?.map((e=>({author:e.role,content:e.content})));return{messages:o,examples:t,context:a}}},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"topP",default:1,min:0,max:1},top_k:{param:"topK",default:1,min:0,max:1},n:{param:"candidateCount",default:1,min:1,max:8},max_tokens:{param:"maxOutputTokens",default:100,min:1},stop:{param:"stopSequences"}},responseTransforms:{complete:(e,t)=>{if(200!==t){const t=Se(e,k);if(t)return t}return"candidates"in e?{id:Date.now().toString(),object:"completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:k,choices:e.candidates?.map(((e,t)=>({text:e.output,index:t,logprobs:null,finish_reason:"length"})))??[]}:M(e,k)},chatComplete:(e,t)=>{if(200!==t){const t=Se(e,k);if(t)return t}return"candidates"in e?{id:Date.now().toString(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:k,choices:e.candidates?.map(((e,t)=>({message:{role:"assistant",content:e.content},index:t,finish_reason:"length"})))??[]}:M(e,k)},embed:(e,t)=>{if(200!==t){const t=Se(e,k);if(t)return t}return"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding.value,index:0}],model:"",usage:{prompt_tokens:-1,total_tokens:-1},provider:k}:M(e,k)}}},"together-ai":{complete:{model:{param:"model",required:!0,default:"togethercomputer/RedPajama-INCITE-7B-Instruct"},prompt:{param:"prompt",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},top_k:{param:"top_k"},frequency_penalty:{param:"repetition_penalty"},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"}},chatComplete:{model:{param:"model",required:!0,default:"togethercomputer/RedPajama-INCITE-Chat-3B-v1"},messages:{param:"messages",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},top_k:{param:"top_k"},frequency_penalty:{param:"repetition_penalty"},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"}},embed:{model:{param:"model",required:!0,default:"mistral-embed"},input:{param:"input",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]}},api:{getBaseURL:()=>"https://api.together.xyz",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"complete":return"/v1/completions";case"chatComplete":return"/v1/chat/completions";case"embed":return"/v1/embeddings";default:return""}}},responseTransforms:{"stream-complete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:v,choices:[{text:a.choices[0]?.text,index:0,finish_reason:""}]})}\n\n`},complete:(e,t)=>{if(200!==t){const t=$e(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:v,choices:e.choices.map((e=>({text:e.text,index:e.index||0,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:M(e,v)},chatComplete:(e,t)=>{if(200!==t){const t=$e(e);if(t)return t}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:v,choices:e.choices.map((e=>({message:{role:"assistant",content:e.message.content,tool_calls:e.message.tool_calls?e.message.tool_calls.map((e=>({id:e.id,type:e.type,function:e.function}))):null},index:0,logprobs:null,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:M(e,v)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:Math.floor(Date.now()/1e3),model:"",provider:v,choices:[{delta:{content:a.choices[0]?.delta.content},index:0,finish_reason:""}]})}\n\n`},embed:(e,t)=>{if(200!==t){const t=$e(e);if(t)return t}return"data"in e?{object:e.object,data:e.data.map((e=>({object:e.object,embedding:e.embedding,index:e.index}))),model:e.model,usage:{prompt_tokens:0,total_tokens:0},provider:v}:M(e,v)}}},google:{api:{getBaseURL:()=>"https://generativelanguage.googleapis.com/v1beta",headers:()=>({"Content-Type":"application/json"}),getEndpoint:({fn:e,providerOptions:t,gatewayRequestBody:a})=>{let r=e;const{model:o,stream:n}=a,{apiKey:s}=t;switch(n&&(r=`stream-${e}`),r){case"chatComplete":return`/models/${o}:generateContent?key=${s}`;case"stream-chatComplete":return`/models/${o}:streamGenerateContent?key=${s}`;case"embed":return`/models/${o}:embedContent?key=${s}`;default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"gemini-pro"},messages:{param:"contents",default:"",transform:e=>{let t;const a=[];return e.messages?.forEach((r=>{const o="assistant"===r.role?"model":"user";let n=[];"string"==typeof r.content&&n.push({text:r.content}),r.content&&"object"==typeof r.content&&r.content.forEach((e=>{"text"===e.type&&n.push({text:e.text}),"image_url"===e.type&&n.push({inlineData:{mimeType:"image/jpeg",data:e.image_url?.url}})}));"user"===t&&"user"===o&&!e.model?.includes("vision")&&a.push({role:"model",parts:[{text:""}]}),a.push({role:o,parts:n}),t=o})),a}},temperature:{param:"generationConfig",transform:e=>Ce(e)},top_p:{param:"generationConfig",transform:e=>Ce(e)},top_k:{param:"generationConfig",transform:e=>Ce(e)},max_tokens:{param:"generationConfig",transform:e=>Ce(e)},stop:{param:"generationConfig",transform:e=>Ce(e)},tools:{param:"tools",default:"",transform:e=>{const t=[];return e.tools?.forEach((e=>{"function"===e.type&&t.push(e.function)})),[{functionDeclarations:t}]}}},embed:{input:{param:"content",required:!0,transform:e=>{const t=[];return Array.isArray(e.input)?e.input.forEach((e=>{t.push({text:e})})):t.push({text:e.input}),{parts:t}}},model:{param:"model",required:!0,default:"embedding-001"}},responseTransforms:{chatComplete:(e,t)=>{if(200!==t){const t=Se(e);if(t)return t}return"candidates"in e?{id:crypto.randomUUID(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:"google",choices:e.candidates?.map(((e,t)=>{let a={role:"assistant",content:""};return e.content.parts[0]?.text?a={role:"assistant",content:e.content.parts[0]?.text}:e.content.parts[0]?.functionCall&&(a={role:"assistant",tool_calls:[{id:crypto.randomUUID(),type:"function",function:{name:e.content.parts[0]?.functionCall.name,arguments:JSON.stringify(e.content.parts[0]?.functionCall.args)}}]}),{message:a,index:e.index,finish_reason:e.finishReason}}))??[]}:M(e,w)},"stream-chatComplete":(e,t)=>{let a=e.trim();if(a.startsWith("[")&&(a=a.slice(1)),a.endsWith(",")&&(a=a.slice(0,a.length-1)),a.endsWith("]")&&(a=a.slice(0,a.length-2)),a=a.replace(/^data: /,""),a=a.trim(),"[DONE]"===a)return`data: ${a}\n\n`;const r=JSON.parse(a);return`data: ${JSON.stringify({id:t,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:"google",choices:r.candidates?.map(((e,t)=>{let a={role:"assistant",content:""};return e.content.parts[0]?.text?a={role:"assistant",content:e.content.parts[0]?.text}:e.content.parts[0]?.functionCall&&(a={role:"assistant",tool_calls:[{id:crypto.randomUUID(),type:"function",index:0,function:{name:e.content.parts[0]?.functionCall.name,arguments:JSON.stringify(e.content.parts[0]?.functionCall.args)}}]}),{delta:a,index:e.index,finish_reason:e.finishReason}}))??[]})}\n\n`},embed:(e,t)=>{if(200!==t){const t=Se(e);if(t)return t}return"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding.values,index:0}],model:"",usage:{prompt_tokens:-1,total_tokens:-1}}:M(e,w)}}},"perplexity-ai":{chatComplete:{model:{param:"model",required:!0,default:"mistral-7b-instruct"},messages:{param:"messages",required:!0,default:[]},max_tokens:{param:"max_tokens",required:!0,min:1},temperature:{param:"temperature",min:0,max:2},top_p:{param:"top_p",min:0,max:1},top_k:{param:"top_k",min:0,max:2048},stream:{param:"stream",default:!1},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"repetition_penalty"},n:{param:"n",max:1,min:1}},api:{getBaseURL:()=>"https://api.perplexity.ai",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"error"in e?P({message:e.error.message,type:e.error.type,param:null,code:e.error.code.toString()},O):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:O,choices:[{message:{role:"assistant",content:e.choices[0]?.message.content},index:0,logprobs:null,finish_reason:""}],usage:{prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens}}:M(e,O),"stream-chatComplete":e=>{let t=e.trim();t=t.replace(/^data: /,""),t=t.trim();const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:Math.floor(Date.now()/1e3),model:a.model,provider:O,choices:[{delta:{role:a.choices[0]?.delta.role,content:a.choices[0]?.delta.content},index:0,finish_reason:a.choices[0]?.finish_reason}]})}\n\n`}}},"mistral-ai":{chatComplete:{model:{param:"model",required:!0,default:"mistral-tiny"},messages:{param:"messages",default:[]},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"top_p",default:1,min:0,max:1},max_tokens:{param:"max_tokens",default:null,min:1},stream:{param:"stream",default:!1},seed:{param:"random_seed",default:null},safe_prompt:{param:"safe_prompt",default:!1},safe_mode:{param:"safe_prompt",default:!1}},embed:{model:{param:"model",required:!0,default:"mistral-embed"},input:{param:"input",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]}},api:{getBaseURL:()=>"https://api.mistral.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>{switch(e){case"chatComplete":return"/chat/completions";case"embed":return"/embeddings";default:return""}}},responseTransforms:{chatComplete:(e,t)=>"message"in e&&200!==t?P({message:e.message,type:e.type,param:e.param,code:e.code},q):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:q,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:M(e,q),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:q,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`},embed:(e,t)=>"message"in e&&200!==t?P({message:e.message,type:e.type,param:e.param,code:e.code},q):"data"in e?{object:e.object,data:e.data.map((e=>({object:e.object,embedding:e.embedding,index:e.index}))),model:e.model,usage:{prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens},provider:q}:M(e,q)}},deepinfra:{chatComplete:{model:{param:"model",required:!0,default:"deepinfra/airoboros-70b"},messages:{param:"messages",required:!0,default:[]},frequency_penalty:{param:"frequency_penalty",default:0,min:-2,max:2},max_tokens:{param:"max_tokens",default:100,min:1},n:{param:"n",default:1,min:1,max:1},presence_penalty:{param:"presence_penalty",min:-2,max:2,default:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stop:{param:"stop",default:null},stream:{param:"stream",default:!1}},api:{getBaseURL:()=>"https://api.deepinfra.com/v1/openai",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>{if("detail"in e&&200!==t&&e.detail.length){let t,a,r=null,o=null;return Array.isArray(e.detail)?([t]=e.detail,r=t?.loc?.join(".")??"",a=t.msg,o=t.type):a=e.detail,P({message:`${r?`${r}: `:""}${a}`,type:o,param:null,code:null},T)}return"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:T,choices:e.choices.map((e=>({index:e.index,message:{role:e.message.role,content:e.message.content},finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens,completion_tokens:e.usage?.completion_tokens,total_tokens:e.usage?.total_tokens}}:M(e,T)},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:T,choices:[{index:a.choices[0].index,delta:a.choices[0].delta,finish_reason:a.choices[0].finish_reason}]})}\n\n`}}},"stability-ai":{api:{getBaseURL:()=>"https://api.stability.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e,gatewayRequestBody:t,providerOptions:a})=>{let r=e;const{urlToFetch:o}=a;return"proxy"===e&&o&&o?.indexOf("text-to-image")>-1&&(r="imageGenerate"),"imageGenerate"===r?`/generation/${t.model}/text-to-image`:""}},imageGenerate:{prompt:{param:"text_prompts",required:!0,transform:e=>[{text:e.prompt,weight:1}]},n:{param:"samples",min:1,max:10},size:[{param:"height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1]),min:320},{param:"width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0]),min:320}],style:{param:"style_preset"},cfg_scale:{param:"cfg_scale"},clip_guidance_preset:{param:"clip_guidance_preset"},sampler:{param:"sampler"},seed:{param:"seed"},steps:{param:"steps"},extras:{param:"extras"}},responseTransforms:{imageGenerate:(e,t)=>200!==t&&"message"in e?P({message:e.message,type:e.name,param:null,code:null},C):"artifacts"in e?{created:`${(new Date).getTime()}`,data:e.artifacts.map((e=>({b64_json:e.base64}))),provider:C}:M(e,C)}},nomic:{embed:{model:{param:"model",required:!0,default:"nomic-embed-text-v1"},input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},task_type:{param:"task_type"}},api:{getBaseURL:()=>"https://api-atlas.nomic.ai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"embed"===e?"/embedding/text":""},responseTransforms:{embed:(e,t)=>"detail"in e&&200!==t&&e.detail.length?(e=>{let t,a,r=null,o=null;return Array.isArray(e.detail)?([t]=e.detail,r=t?.loc?.join(".")??"",a=t.msg,o=t.type):a=e.detail,P({message:`${r?`${r}: `:""}${a}`,type:o,param:null,code:null},S)})(e):"embeddings"in e?{object:"list",data:e.embeddings.map(((e,t)=>({object:"embedding",embedding:e,index:t}))),model:e.model,usage:{prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens},provider:S}:M(e,S)}},ollama:{embed:{model:{param:"model"},input:{param:"prompt",required:!0}},api:{headers:()=>({}),getBaseURL:({providerOptions:e})=>e.customHost??"",getEndpoint:({fn:e,providerOptions:t})=>{let a=e;const{urlToFetch:r}=t;switch("proxy"===e&&r&&r?.indexOf("/api/chat")>-1?a="chatComplete":"proxy"===e&&r&&r?.indexOf("/embeddings")>-1&&(a="embed"),a){case"chatComplete":return"/v1/chat/completions";case"embed":return"/api/embeddings";default:return""}}},chatComplete:{model:{param:"model",required:!0,default:"llama2"},messages:{param:"messages",default:""},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},presence_penalty:{param:"presence_penalty",min:-2,max:2},response_format:{param:"response_format"},seed:{param:"seed"},stop:{param:"stop"},stream:{param:"stream",default:!1},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},max_tokens:{param:"max_tokens",default:100,min:0}},responseTransforms:{chatComplete:(e,t)=>200!==t?P({message:e.error?.message,type:e.error?.type,param:null,code:null},j):{id:e.id,object:e.object,created:e.created,model:e.model,provider:j,choices:e.choices,usage:e.usage},"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:j,choices:a.choices})}\n\n`},embed:(e,t)=>"error"in e?P({message:e.error,type:null,param:null,code:null},j):"embedding"in e?{object:"list",data:[{object:"embedding",embedding:e.embedding,index:0}],model:"",usage:{prompt_tokens:-1,total_tokens:-1}}:M(e,j)}},ai21:{complete:{prompt:{param:"prompt",required:!0},n:{param:"numResults",default:1},max_tokens:{param:"maxTokens",default:16},minTokens:{param:"minTokens",default:0},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},top_k:{param:"topKReturn",default:0},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},chatComplete:{messages:[{param:"messages",required:!0,transform:e=>{let t=[];return"system"===e.messages?.[0]?.role?t=e.messages.slice(1):e.messages&&(t=e.messages),t.map((e=>({text:e.content,role:e.role})))}},{param:"system",required:!1,transform:e=>{if("system"===e.messages?.[0].role)return e.messages?.[0].content}}],n:{param:"numResults",default:1},max_tokens:{param:"maxTokens",default:16},minTokens:{param:"minTokens",default:0},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"topP",default:1},top_k:{param:"topKReturn",default:0},stop:{param:"stopSequences"},presence_penalty:{param:"presencePenalty",transform:e=>({scale:e.presence_penalty})},frequency_penalty:{param:"frequencyPenalty",transform:e=>({scale:e.frequency_penalty})},countPenalty:{param:"countPenalty"},frequencyPenalty:{param:"frequencyPenalty"},presencePenalty:{param:"presencePenalty"}},embed:{input:{param:"texts",required:!0,transform:e=>Array.isArray(e.input)?e.input:[e.input]},type:{param:"type"}},api:{getBaseURL:()=>"https://api.ai21.com/studio/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e,gatewayRequestBody:t})=>{const{model:a}=t;switch(e){case"complete":return`/${a}/complete`;case"chatComplete":return`/${a}/chat`;case"embed":return"/embed";default:return""}}},responseTransforms:{complete:(e,t)=>{if(200!==t){const t=J(e);if(t)return t}if("completions"in e){const t=e.prompt.tokens?.length||0,a=e.completions.map((e=>e.data?.tokens?.length||0)).reduce(((e,t)=>e+t),0);return{id:e.id,object:"text_completion",created:Math.floor(Date.now()/1e3),model:"",provider:$,choices:e.completions.map(((e,t)=>({text:e.data.text,index:t,logprobs:null,finish_reason:e.finishReason?.reason}))),usage:{prompt_tokens:t,completion_tokens:a,total_tokens:t+a}}}return M(e,$)},chatComplete:(e,t)=>{if(200!==t){const t=J(e);if(t)return t}return"outputs"in e?{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"",provider:$,choices:e.outputs.map(((e,t)=>({message:{role:"assistant",content:e.text},index:t,logprobs:null,finish_reason:e.finishReason?.reason})))}:M(e,$)},embed:(e,t)=>{if(200!==t){const t=J(e);if(t)return t}return"results"in e?{object:"list",data:e.results.map(((e,t)=>({object:"embedding",embedding:e.embedding,index:t}))),model:"",provider:$,usage:{prompt_tokens:-1,total_tokens:-1}}:M(e,$)}}},bedrock:{api:L,getConfig:e=>{const t=e.model,a=t?.split(".")[0];switch(a){case x:return{complete:se,chatComplete:H,api:L,responseTransforms:{"stream-complete":ye,complete:_e,"stream-chatComplete":re,chatComplete:ae}};case _:return{complete:ie,chatComplete:K,embed:ke,api:L,responseTransforms:{"stream-complete":be,complete:xe,"stream-chatComplete":ne,chatComplete:oe,embed:Oe}};case"meta":return{complete:pe,chatComplete:G,api:L,responseTransforms:{"stream-complete":ue,complete:de,"stream-chatComplete":Q,chatComplete:Y}};case"amazon":return{complete:ce,chatComplete:F,embed:ve,api:L,responseTransforms:{"stream-complete":ge,complete:fe,"stream-chatComplete":ee,chatComplete:Z,embed:we}};case $:return{complete:le,chatComplete:X,api:L,responseTransforms:{complete:he,chatComplete:te}};case"stability":return{imageGenerate:qe,api:L,responseTransforms:{imageGenerate:Te}}}}},groq:{chatComplete:{model:{param:"model",required:!0,default:"mixtral-8x7b-32768"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1},stop:{param:"stop"},n:{param:"n",default:1,max:1,min:1}},api:{getBaseURL:()=>"https://api.groq.com/openai/v1",headers:({providerOptions:e})=>({Authorization:`Bearer ${e.apiKey}`}),getEndpoint:({fn:e})=>"chatComplete"===e?"/chat/completions":""},responseTransforms:{chatComplete:(e,t)=>"error"in e&&200!==t?P({message:e.error.message,type:e.error.type,param:null,code:e.error.code?.toString()||null},E):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:E,choices:e.choices.map((e=>({index:e.index,message:e.message,logprobs:e.logprobs,finish_reason:e.finish_reason}))),usage:{prompt_tokens:e.usage?.prompt_tokens||0,completion_tokens:e.usage?.completion_tokens||0,total_tokens:e.usage?.total_tokens||0}}:M(e,E),"stream-chatComplete":e=>{let t=e.trim();if(t=t.replace(/^data: /,""),t=t.trim(),"[DONE]"===t)return`data: ${t}\n\n`;const a=JSON.parse(t);return a.x_groq&&a.x_groq.usage?`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:E,choices:[{index:a.choices[0].index||0,delta:{},logprobs:null,finish_reason:a.choices[0].index}],usage:{prompt_tokens:a.x_groq.usage.prompt_tokens||0,completion_tokens:a.x_groq.usage.completion_tokens||0,total_tokens:a.x_groq.usage.total_tokens||0}})}\n\n`:`data: ${JSON.stringify({id:a.id,object:a.object,created:a.created,model:a.model,provider:E,choices:[{index:a.choices[0].index||0,delta:{role:"assistant",content:a.choices[0].delta.content},logprobs:null,finish_reason:a.choices[0].finish_reason||null}]})}\n\n`}}},segmind:{api:{getBaseURL:()=>"https://api.segmind.com/v1",headers:({providerOptions:e})=>({"x-api-key":`${e.apiKey}`}),getEndpoint:({gatewayRequestBody:e})=>`/${e.model}`},imageGenerate:{prompt:{param:"prompt",required:!0},n:{param:"samples",min:1,max:10,default:1},size:[{param:"img_height",transform:e=>parseInt(e.size.toLowerCase().split("x")[1])},{param:"img_width",transform:e=>parseInt(e.size.toLowerCase().split("x")[0])}],style:{param:"style",default:"base"},steps:{param:"num_inference_steps",default:20,required:!0},negative_prompt:{param:"negative_prompt",default:"out of frame, duplicate, watermark, signature, text, error, deformed"},scheduler:{param:"scheduler",default:"UniPC"},guidance_scale:{param:"guidance_scale",default:7.5},seed:{param:"seed",default:Math.floor(1e9*Math.random())},strength:{param:"strength",default:.75},refiner:{param:"refiner",default:!0},high_noise_fraction:{param:"high_noise_fraction",default:.8},base64:{param:"base64",transform:e=>!0,default:!0,required:!0},control_scale:{param:"control_scale",default:1.8},control_start:{param:"control_start",default:.19},control_end:{param:"control_end",default:1},qr_text:{param:"qr_text",default:"https://portkey.ai"},invert:{param:"invert",default:!1},qr_size:{param:"size",default:768}},responseTransforms:{imageGenerate:(e,t)=>{if(200!==t&&"error"in e)return P({message:e.error??"",type:null,param:null,code:null},R);if(200!==t&&"html-message"in e)return P({message:e["html-message"]??"",type:null,param:null,code:null},R);if("image"in e){let t=(Array.isArray(e.image)?e.image:[e.image]).map((e=>({b64_json:e})));return{created:`${(new Date).getTime()}`,data:t,provider:R}}return M(e,R)}}}};function Ee(e,t,a){const r=t.split(".");let o=e;for(let e=0;e<r.length-1;e++)o[r[e]]||(o[r[e]]={}),o=o[r[e]];o[r[r.length-1]]=a}const Re=(e,t,a)=>{let r=Ne[e];if(r=r.getConfig?r.getConfig(t)[a]:r[a],!r)throw new Error("Unsupported provider");const o={};for(const e in r){let a=r[e];Array.isArray(a)||(a=[a]);for(const r of a)if(e in t){let a=t[e];r.transform&&(a=r.transform(t)),"portkey-default"===a&&r&&void 0!==r.default&&(a=r.default),"number"==typeof a&&r&&void 0!==r.min&&a<r.min?a=r.min:"number"==typeof a&&r&&void 0!==r.max&&a>r.max&&(a=r.max),Ee(o,r?.param,a)}else r&&r.required&&void 0!==r.default&&Ee(o,r.param,r.default)}return o},Ae=(e,t)=>{let a="\n\n";return e===x&&t.endsWith("/complete")&&(a="\r\n\r\n"),e===_&&(a="\n"),e===w&&(a="\r\n"),e===O&&(a="\r\n\r\n"),e===T&&(a="\r\n\r\n"),a};function De(e,t=[]){return"object"!=typeof e||null===e?e:Array.isArray(e)?e.map((e=>De(e,t))):Object.keys(e).reduce(((a,r)=>{const o=e[r],n=r.replace(/(_\w)/g,(e=>e[1].toUpperCase()));const s=t.includes(r);return a[n]="object"!=typeof o||s?o:De(o,t),a}),{})}const Me=async(e,t,a,r,o)=>{let n,i,p;try{await s((async(s,p)=>{try{const a=o?await async function(e,t,a){const r={...t,signal:AbortSignal.timeout(a)};let o;try{o=await fetch(e,r)}catch(e){if("TimeoutError"!==e.name)throw e;o=new Response(JSON.stringify({error:{message:`Request exceeded the timeout sent in the request: ${a}ms`,type:"timeout_error",param:null,code:null}}),{headers:{"content-type":"application/json"},status:408})}return o}(e,t,o):await fetch(e,t);if(r.includes(a.status)){const e=new Error(await a.text());throw e.status=a.status,e.headers=Object.fromEntries(a.headers),e}if(!(a.status>=200&&a.status<=204)){const e=new Error(await a.clone().text());return e.status=a.status,e.headers=Object.fromEntries(a.headers),void s(e)}console.log(`Returned in Retry Attempt ${p}. Status:`,a.ok,a.status),i=a}catch(e){if(n=e,p>=a+1)return void s(e);throw e}}),{retries:a,onRetry:(e,t)=>{p=t,console.warn(`Failed in Retry attempt ${t}. Error: ${e}`)},randomize:!1})}catch(e){i=new Response(e.message,{status:e.status,headers:e.headers}),console.warn(`Tried ${p} time(s) but failed. Error: ${JSON.stringify(e)}`)}return[i,p]};function Pe(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function Je(e){const t=new TextDecoder,a=Pe(e,0),r=12+Pe(e,4),o=a-r-4,n=e.slice(r,r+o);return t.decode(n)}function Ie(e,t){const a=new Uint8Array(e.length+t.length);return a.set(e,0),a.set(t,e.length),a}async function Be(e,t,a,r){const o=Ae(t,r),n=Date.now().toString();if(!e.body)throw new Error("Response format is invalid. Body not found");const{readable:s,writable:i}=new TransformStream,p=i.getWriter(),m=e.body.getReader(),c=t===y,l=new TextEncoder;return t===N?(async()=>{for await(const e of async function*(e,t,a){let r=new Uint8Array,o=0;for(;;){const{done:s,value:i}=await e.read();if(s){if(r.length)for(o=Pe(r,0);r.length>=o&&0!==r.length;){const e=r.subarray(0,o);r=r.subarray(o),o=Pe(r,0);const s=Buffer.from(JSON.parse(Je(e)).bytes,"base64").toString();if(t){const e=t(s,a);if(Array.isArray(e))for(var n of e)yield n;else yield e}else yield e}break}for(0===o&&(o=Pe(i,0)),r=Ie(r,i);r.length>=o&&0!==r.length;){const e=r.subarray(0,o);r=r.subarray(o),o=Pe(r,0);const s=Buffer.from(JSON.parse(Je(e)).bytes,"base64").toString();if(t){const e=t(s,a);if(Array.isArray(e))for(var n of e)yield n;else yield e}else yield e}}}(m,a,n))await p.write(l.encode(e));p.close()})():(async()=>{for await(const e of async function*(e,t,a,r,o){let n="",s=new TextDecoder,i=!0;for(;;){const{done:p,value:m}=await e.read();if(p){n.length>0&&(a?yield a(n,o):yield n);break}for(n+=s.decode(m,{stream:!0});n.split(t).length>1;){let e=n.split(t),s=e.pop()??"";for(let n of e)if(n.length>0)if(i?(i=!1,await new Promise((e=>setTimeout(e,25)))):r&&await new Promise((e=>setTimeout(e,1))),a){const e=a(n,o);void 0!==e&&(yield e)}else yield n+t;n=s}}}(m,o,a,c,n))await p.write(l.encode(e));p.close()})(),[w,_,N].includes(t)&&a?new Response(s,{...e,headers:new Headers({...Object.fromEntries(e.headers),"content-type":"text/event-stream"})}):new Response(s,e)}function ze(e,t,a,r,o){let n={...e};const s={};r.forEach((e=>{o[e]&&(s[e]=o[e])})),n={"content-type":"application/json",...n,...s};let i={method:a,headers:n};if("GET"===a&&i.headers){delete i.headers["content-type"]}return i}function Ue(e){let t=(e=e.map((e=>({...e,weight:e.weight??1})))).reduce(((e,t)=>e+t.weight),0),a=Math.random()*t;for(let[t,r]of e.entries()){if(a<r.weight)return{...r,index:t};a-=r.weight}throw new Error("No provider selected, please check the weights")}const Le=e=>{let t,a=null;const r=De(e,["override_params","params","metadata"]);return"provider"in r?(a=[{provider:r.provider,virtualKey:r.virtualKey,apiKey:r.apiKey,cache:r.cache,retry:r.retry,customHost:r.customHost}],r.resourceName&&(a[0].resourceName=r.resourceName),r.deploymentId&&(a[0].deploymentId=r.deploymentId),r.apiVersion&&(a[0].apiVersion=r.apiVersion),t="single"):(t=r.strategy&&r.strategy.mode?r.strategy.mode:r.mode,a=function(e,t){switch(t.targets&&(t.options=t.targets),t.options&&t.options.forEach((e=>{t.cache&&!e.cache&&(e.cache=t.cache),t.retry&&!e.retry&&(e.retry=t.retry)})),e){case"single":return[t.options[0]];case"loadbalance":return[Ue(t.options)];case"fallback":return t.options;default:return null}}(t,r)),a};async function He(e,t,a,r,o,n,s="POST"){const p={...a,...t?.overrideParams||{}},m=!!p.stream,c=t.provider??"",l=Ne[c].api,u=r[d.CUSTOM_HOST]||t.customHost||""||l.getBaseURL({providerOptions:t}),g=l.getEndpoint({providerOptions:t,fn:o,gatewayRequestBody:p}),h=g?`${u}${g}`:t.urlToFetch,_=ze(await l.headers({providerOptions:t,fn:o,transformedRequestBody:p,transformedRequestUrl:h}),0,s,[],r);let y,x;"POST"===s&&(_.body=JSON.stringify(p)),t.retry&&"object"==typeof t.retry?t.retry={attempts:t.retry?.attempts??0,onStatusCodes:t.retry?.onStatusCodes??f}:"number"==typeof t.retry?t.retry={attempts:t.retry,onStatusCodes:f}:t.retry={attempts:1,onStatusCodes:[]};const b=e.get("getFromCache"),k=e.get("cacheIdentifier"),v=e.get("requestOptions")??[];let w,O,q,T,C="DISABLED";if(r[d.CACHE]?q=r[d.CACHE]:t?.cache&&"object"==typeof t.cache&&t.cache.mode?(q=t.cache.mode,T=t.cache.maxAge):t?.cache&&"string"==typeof t.cache&&(q=t.cache),b&&q&&([w,C,O]=await b(i(e),{...r,..._.headers},p,h,k,q,T),w))return y=await We(new Response(w,{headers:{"content-type":"application/json"}}),!1,c,void 0,h,!1,p),e.set("requestOptions",[...v,{providerOptions:{...t,requestURL:h,rubeusURL:o},requestParams:p,response:y.clone(),cacheStatus:C,lastUsedOptionIndex:n,cacheKey:O,cacheMode:q,cacheMaxAge:T}]),Xe(y,n,p,C,0,r[d.TRACE_ID]??""),y;[y,x]=await Me(h,_,t.retry.attempts,t.retry.onStatusCodes,null);const S=await We(y,m,c,void 0,h,!1,p);if(Xe(S,n,p,C,x??0,r[d.TRACE_ID]??""),e.set("requestOptions",[...v,{providerOptions:{...t,requestURL:h,rubeusURL:o},requestParams:p,response:S.clone(),cacheStatus:C,lastUsedOptionIndex:n,cacheKey:O,cacheMode:q}]),!y.ok){const e=new Error(await S.text());throw e.status=S.status,e}return S}async function Ke(e,t,a,r,o,n){const s={...a,...t?.overrideParams||{}},p=!!s.stream,m=t.provider??"",c=Ne[m].api,l=Re(m,s,o),u=r[d.FORWARD_HEADERS]?.split(",").map((e=>e.trim()))||t.forwardHeaders||[],g=`${r[d.CUSTOM_HOST]||t.customHost||""||c.getBaseURL({providerOptions:t})}${c.getEndpoint({providerOptions:t,fn:o,gatewayRequestBody:s})}`,h=ze(await c.headers({providerOptions:t,fn:o,transformedRequestBody:l,transformedRequestUrl:g}),0,"POST",u,r);let _,y;h.body=JSON.stringify(l),t.retry={attempts:t.retry?.attempts??0,onStatusCodes:t.retry?.onStatusCodes??f};const[x,b,k]=[e.get("getFromCache"),e.get("cacheIdentifier"),e.get("requestOptions")??[]];let v,w,O,q,T="DISABLED";if("object"==typeof t.cache&&t.cache?.mode?(O=t.cache.mode,q=t.cache.maxAge):"string"==typeof t.cache&&(O=t.cache),x&&O&&([v,T,w]=await x(i(e),{...r,...h.headers},l,o,b,O,q),v))return _=await We(new Response(v,{headers:{"content-type":"application/json"}}),p,m,o,g,!0,s),e.set("requestOptions",[...k,{providerOptions:{...t,requestURL:g,rubeusURL:o},requestParams:l,response:_.clone(),cacheStatus:T,lastUsedOptionIndex:n,cacheKey:w,cacheMode:O}]),Xe(_,n,s,T,0,r[d.TRACE_ID]??""),_;[_,y]=await Me(g,h,t.retry.attempts,t.retry.onStatusCodes,t.requestTimeout||null);const C=await We(_,p,m,o,g,!1,s);if(Xe(C,n,s,T,y??0,r[d.TRACE_ID]??""),e.set("requestOptions",[...k,{providerOptions:{...t,requestURL:g,rubeusURL:o},requestParams:l,response:C.clone(),cacheStatus:T,lastUsedOptionIndex:n,cacheKey:w,cacheMode:O,cacheMaxAge:q}]),!_.ok){const e=new Error(await C.clone().text());throw e.status=C.status,e.response=C,e}return C}async function Ge(e,t,a,r,o,n="POST"){let s=[];for(let[i,p]of t.entries())try{const t=isNaN(Number(p.index))?null:Number(p.index);return"proxy"===o?await He(e,p,a,r,o,t??i,n):await Ke(e,p,a,r,o,t??i)}catch(e){s.push({provider:p.provider,errorObj:e.message,status:e.status})}throw new Error(JSON.stringify(s))}function We(e,t,a,r,o,n=!1,s){let i;const p=e.headers?.get("content-type"),m=Ne[a];let c=Ne[a]?.responseTransforms;return m.getConfig&&(c=m.getConfig(s).responseTransforms),r&&t&&200===e.status?i=c?.[`stream-${r}`]:r&&(i=c?.[r]),r&&t&&n?i="chatComplete"===r?U:je:r&&!t&&n&&(i=void 0),t&&200===e.status&&n&&i?async function(e,t,a){const{readable:r,writable:o}=new TransformStream,n=o.getWriter(),s=new TextEncoder,i=a(await e.clone().json(),t);return(async()=>{for(const e of i)await n.write(s.encode(e));n.close()})(),new Response(r,{headers:new Headers({...Object.fromEntries(e.headers),"content-type":D.EVENT_STREAM})})}(e,a,i):t&&200===e.status?Be(e,a,i,o):p?.startsWith(D.GENERIC_AUDIO_PATTERN)||p===D.APPLICATION_OCTET_STREAM||p?.startsWith(D.GENERIC_IMAGE_PATTERN)?async function(e){return new Response(e.body,e)}(e):p?.startsWith(D.PLAIN_TEXT)||p?.startsWith(D.HTML)?async function(e,t){const a=await e.text();if(t){const r=t({"html-message":a},e.status);return new Response(JSON.stringify(r),{...e,status:e.status,headers:new Headers({...Object.fromEntries(e.headers),"content-type":"application/json"})})}return new Response(a,e)}(e,i):async function(e,t){if(e.status===g)return e;let a=await e.json();return t&&(a=t(a,e.status,e.headers)),new Response(JSON.stringify(a),e)}(e,i)}async function Fe(e,t,a,r,o,n,s,i={}){let p={...t},m=s;const c=p.strategy?.mode,l={overrideParams:{...i.overrideParams,...p.overrideParams},retry:p.retry?{...p.retry}:{...i.retry},cache:p.cache?{...p.cache}:{...i.cache},requestTimeout:null};let d;switch(p.forwardHeaders?l.forwardHeaders=[...p.forwardHeaders]:i.forwardHeaders&&(l.forwardHeaders=[...i.forwardHeaders],p.forwardHeaders=[...i.forwardHeaders]),p.customHost?l.customHost=p.customHost:i.customHost&&(l.customHost=i.customHost,p.customHost=i.customHost),p.requestTimeout?l.requestTimeout=p.requestTimeout:i.requestTimeout&&(l.requestTimeout=i.requestTimeout,p.requestTimeout=i.requestTimeout),p.overrideParams={...l.overrideParams},p.retry={...l.retry},p.cache={...l.cache},c){case"fallback":for(let[t,s]of p.targets.entries())if(d=await Fe(e,s,a,r,o,n,`${m}.targets[${t}]`,l),d?.ok||p.strategy.onStatusCodes&&!p.strategy.onStatusCodes.includes(d?.status))break;break;case"loadbalance":p.targets.forEach((e=>{void 0===e.weight&&(e.weight=1)}));let t=p.targets.reduce(((e,t)=>e+t.weight),0),s=Math.random()*t;for(let[t,i]of p.targets.entries()){if(s<i.weight){m+=`.targets[${t}]`,d=await Fe(e,i,a,r,o,n,m,l);break}s-=i.weight}break;case"single":d=await Fe(e,p.targets[0],a,r,o,n,`${m}.targets[0]`,l);break;default:try{d=await Ke(e,p,a,r,o,m)}catch(e){d=e.response}}return d}function Xe(e,t,a,r,o,n){e.headers.append(u.LAST_USED_OPTION_INDEX,t.toString()),e.headers.append(u.CACHE_STATUS,r),e.headers.append(u.TRACE_ID,n),e.headers.append(u.RETRY_ATTEMPT_COUNT,o.toString());const s=e.headers.get("content-encoding");s&&s.indexOf("br")>-1&&e.headers.delete("content-encoding"),e.headers.delete("content-length")}function Ve(e){const t={resourceName:e[`x-${l}-azure-resource-name`],deploymentId:e[`x-${l}-azure-deployment-id`],apiVersion:e[`x-${l}-azure-api-version`]},a={awsAccessKeyId:e[`x-${l}-aws-access-key-id`],awsSecretAccessKey:e[`x-${l}-aws-secret-access-key`],awsSessionToken:e[`x-${l}-aws-session-token`],awsRegion:e[`x-${l}-aws-region`]};if(e[`x-${l}-config`]){let r=JSON.parse(e[`x-${l}-config`]);return r.provider||r.targets||(r.provider=e[`x-${l}-provider`],r.api_key=e.authorization?.replace("Bearer ",""),r.provider===y&&(r={...r,...t}),r.provider===N&&(r={...r,...a})),De(r,["override_params","params"])}return{provider:e[`x-${l}-provider`],apiKey:e.authorization?.replace("Bearer ",""),...e[`x-${l}-provider`]===y&&t,...e[`x-${l}-provider`]===N&&a}}function Ye(e,t){let a={};const r=`x-${l}-`,o=[...t];return e["content-type"]?.split(";")[0]===D.MULTIPART_FORM_DATA&&o.push("content-type"),o.push("content-length"),Object.keys(e).forEach((t=>{o.includes(t)||t.startsWith(r)||(a[t]=e[t])})),a}async function Qe(e){try{const s=Object.fromEntries(e.req.raw.headers),p=s["content-type"]?.split(";")[0],[m,c]=await async function(e,t){let a,r={},o="";if(t==D.APPLICATION_JSON){if(["GET","DELETE"].includes(e.method))return[r,a];o=await e.text(),r=JSON.parse(o)}else t==D.MULTIPART_FORM_DATA&&(a=await e.formData(),a.forEach((function(e,t){r[t]=e})));return[r,a]}(e.req.raw,p),u={proxyProvider:(o=s[d.MODE],n=s[`x-${l}-provider`],o?.split(" ")[1]??n),reqBody:m,requestFormData:c,customHeadersToAvoid:i(e).CUSTOM_HEADERS_TO_IGNORE??[],proxyPath:e.req.url.indexOf("/v1/proxy")>-1?"/v1/proxy":"/v1"};let g=null;s[`x-${l}-config`]&&(g=JSON.parse(s[`x-${l}-config`]),g&&"provider"in g&&(u.proxyProvider=g.provider));const h=s[d.CUSTOM_HOST]||g?.customHost||"";let _=function(e,t,a,r){let o=new URL(e),n=o.pathname;const s=o.search;if(n=n.replace(a,""),r)return`${r}${n}${s}`;const i=Ne[t].api.getBaseURL({providerOptions:{}});if(t===y)return`https:/${n}${s}`;if(t===j)return`https:/${n}`;let p=`${i}${n}${s}`;return t===x&&(p=p.replace("/v1/v1/","/v1/")),p}(e.req.url,u.proxyProvider,u.proxyPath,h);if(u.isStreamingMode=(t=u.reqBody,a=u.proxyProvider,r=_,a===w&&r.indexOf("stream")>-1||t.stream),g&&("options"in g&&g.options||"targets"in g&&g.targets||"provider"in g&&g.provider)){let t=Le(g);if(!t)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});t=t.map((e=>({...e,urlToFetch:_})));try{return await Ge(e,t,u.reqBody,s,"proxy")}catch(e){const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}g&&(g=De(g,["override_params","params","metadata"]));let b={headers:Ye(s,u.customHeadersToAvoid),method:e.req.method,body:p===D.MULTIPART_FORM_DATA?u.requestFormData:JSON.stringify(u.reqBody)},k=0,v=f;s[d.RETRIES]?k=parseInt(s[d.RETRIES]):g?.retry&&"object"==typeof g.retry&&(k=g.retry?.attempts??1,v=g.retry?.onStatusCodes??f),k=Math.min(k,5);const O=e.get("getFromCache"),q=e.get("cacheIdentifier");let T,C,S,$="DISABLED",N=s[d.CACHE];if(g?.cache&&"object"==typeof g.cache&&g.cache.mode?(N=g.cache.mode,S=g.cache.maxAge):g?.cache&&"string"==typeof g.cache&&(N=g.cache),O&&N&&([T,$,C]=await O(i(e),{...s,...b.headers},u.reqBody,_,q,N),T)){const t=await We(new Response(T,{headers:{"content-type":"application/json"}}),!1,u.proxyProvider,void 0,_,!1,u.reqBody);return e.set("requestOptions",[{providerOptions:{...u.reqBody,provider:u.proxyProvider,requestURL:_,rubeusURL:"proxy"},requestParams:u.reqBody,response:t.clone(),cacheStatus:$,cacheKey:C,cacheMode:N,cacheMaxAge:S}]),Xe(t,0,u.reqBody,$,0,s[d.TRACE_ID]??""),t}let[E,R]=await Me(_,b,k,v,null);const A=await We(E,u.isStreamingMode,u.proxyProvider,void 0,_,!1,u.reqBody);return Xe(A,0,u.reqBody,$,R??0,s[d.TRACE_ID]??""),e.set("requestOptions",[{providerOptions:{...u.reqBody,provider:u.proxyProvider,requestURL:_,rubeusURL:"proxy"},requestParams:u.reqBody,response:A.clone(),cacheStatus:$,cacheKey:C,cacheMode:N,cacheMaxAge:S}]),A}catch(e){return console.log("proxy error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}var t,a,r,o,n}function Ze(e,t){let a={};const r=`x-${l}-`,o=[...t];return o.push("content-length"),Object.keys(e).forEach((t=>{o.includes(t)||t.startsWith(r)||(a[t]=e[t])})),a["accept-encoding"]="gzip, deflate",a}async function et(e){try{const r=Object.fromEntries(e.req.raw.headers);delete r["content-type"];const o={proxyProvider:(t=r[d.MODE],a=r[d.PROVIDER],t?.split(" ")[1]??a),customHeadersToAvoid:i(e).CUSTOM_HEADERS_TO_IGNORE??[],reqBody:{},proxyPath:e.req.url.indexOf("/v1/proxy")>-1?"/v1/proxy":"/v1"},n=r[d.CUSTOM_HOST]||"";let s=function(e,t,a,r){let o=new URL(e),n=o.pathname;const s=o.search;if(n=n.replace(a,""),r)return`${r}${n}${s}`;const i=Ne[t].api.getBaseURL({providerOptions:{}});if(t===y)return`https:/${n}${s}`;let p=`${i}${n}${s}`;return t===x&&(p=p.replace("/v1/v1/","/v1/")),p}(e.req.url,o.proxyProvider,o.proxyPath,n),p={headers:Ze(r,o.customHeadersToAvoid),method:e.req.method},m=Math.min(parseInt(r[d.RETRIES])||1,5),[c,l]=await Me(s,p,m,f,null);const u=await We(c,o.isStreamingMode,o.proxyProvider,void 0,s,!1,o.reqBody);return Xe(u,0,o.reqBody,"DISABLED",l??0,r[d.TRACE_ID]??""),e.set("requestOptions",[{providerOptions:{...o.reqBody,provider:o.proxyProvider,requestURL:s,rubeusURL:"proxy"},requestParams:o.reqBody,response:u.clone(),cacheStatus:"DISABLED",cacheKey:void 0}]),u}catch(e){return console.log("proxyGet error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}var t,a}async function tt(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const r=Ve(a);return await Fe(e,r??{},t,a,"chatComplete","POST","config")}catch(e){return console.log("chatCompletion error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}}async function at(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const r=Ve(a);return await Fe(e,r,t,a,"complete","POST","config")}catch(e){return console.log("completion error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}}const rt=m.object({strategy:m.object({mode:m.string().refine((e=>["single","loadbalance","fallback"].includes(e)),{message:"Invalid 'mode' value. Must be one of: single, loadbalance, fallback"}),on_status_codes:m.array(m.number()).optional()}).optional(),provider:m.string().refine((e=>A.includes(e)),{message:`Invalid 'provider' value. Must be one of: ${A.join(", ")}`}).optional(),api_key:m.string().optional(),aws_secret_access_key:m.string().optional(),aws_access_key_id:m.string().optional(),aws_session_token:m.string().optional(),aws_region:m.string().optional(),cache:m.object({mode:m.string().refine((e=>["simple","semantic"].includes(e)),{message:"Invalid 'cache.mode' value. Must be one of: simple, semantic"}),max_age:m.number().optional()}).refine((e=>void 0!==e.mode),{message:"'cache.mode' must be defined"}).optional(),retry:m.object({attempts:m.number(),on_status_codes:m.array(m.number()).optional()}).refine((e=>void 0!==e.attempts),{message:"'retry.attempts' must be defined"}).optional(),weight:m.number().optional(),on_status_codes:m.array(m.number()).optional(),targets:m.array(m.lazy((()=>rt))).optional(),request_timeout:m.number().optional(),custom_host:m.string().optional(),forward_headers:m.array(m.string()).optional()}).refine((e=>{const t=void 0!==e.provider&&void 0!==e.api_key,a=void 0!==e.strategy&&void 0!==e.targets,r=e.provider===j,o=e.aws_access_key_id&&e.aws_secret_access_key;return t||a||e.cache||e.retry||e.request_timeout||r||o}),{message:"Invalid configuration. It must have either 'provider' and 'api_key', or 'strategy' and 'targets', or 'cache', or 'retry', or 'request_timeout'"}).refine((e=>{const t=e.custom_host;return!(t&&t.indexOf("api.portkey")>-1)}),{message:"Invalid custom host"}),ot=(e,t)=>{const a=Object.fromEntries(e.req.raw.headers);if(a["content-type"]&&![D.APPLICATION_JSON,D.MULTIPART_FORM_DATA].includes(a["content-type"].split(";")[0]))return new Response(JSON.stringify({status:"failure",message:"Invalid content type passed"}),{status:400,headers:{"content-type":"application/json"}});if(!a[`x-${l}-config`]&&!a[`x-${l}-provider`])return new Response(JSON.stringify({status:"failure",message:`Either x-${l}-config or x-${l}-provider header is required`}),{status:400,headers:{"content-type":"application/json"}});if(a[`x-${l}-provider`]&&!A.includes(a[`x-${l}-provider`]))return new Response(JSON.stringify({status:"failure",message:"Invalid provider passed"}),{status:400,headers:{"content-type":"application/json"}});const r=a[`x-${l}-custom-host`];if(r&&r.indexOf("api.portkey")>-1)return new Response(JSON.stringify({status:"failure",message:"Invalid custom host"}),{status:400,headers:{"content-type":"application/json"}});if(a[`x-${l}-config`])try{const e=JSON.parse(a[`x-${l}-config`]);if(!a[`x-${l}-provider`]&&!e.provider&&!e.targets)return new Response(JSON.stringify({status:"failure",message:`Either x-${l}-provider needs to be passed. Or the x-${l}-config header should have a valid config with provider details in it.`}),{status:400,headers:{"content-type":"application/json"}});const t=rt.safeParse(e);if(!t.success&&t.error?.issues?.length)return new Response(JSON.stringify({status:"failure",message:"Invalid config passed",errors:t.error.issues.map((e=>`path: ${e.path}, message: ${e.message}`))}),{status:400,headers:{"content-type":"application/json"}});if(e.options)return new Response(JSON.stringify({status:"failure",message:"This version of config is not supported in this route. Please migrate to the latest version"}),{status:400,headers:{"content-type":"application/json"}})}catch(e){return new Response(JSON.stringify({status:"failure",message:"Invalid config passed. You need to pass a valid json"}),{status:400,headers:{"content-type":"application/json"}})}return t()};const nt=new t;nt.use("*",((e,t)=>{const a=p();return"lagon"!==a&&"workerd"!==a?c()(e,t):t()})),nt.get("/",(e=>e.text("AI Gateway says hey!"))),nt.use("*",a()),nt.notFound((e=>e.json({message:"Not Found",ok:!1},404))),nt.onError(((e,t)=>e instanceof r?e.getResponse():(t.status(500),t.json({status:"failure",message:e.message})))),nt.post("/v1/complete",(async function(e){try{const t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);if(t.config?.targets&&t.config?.targets?.filter((e=>e.targets)).length>0)return new Response(JSON.stringify({status:"failure",message:"Please use the latest routes or SDK to use this version of config."}),{status:400,headers:{"content-type":"application/json"}});const r=Le(t.config);if(!r)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});try{return await Ge(e,r,t.params,a,"complete")}catch(e){const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}catch(e){return console.log("complete error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),nt.post("/v1/chatComplete",(async function(e){try{const t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);if(t.config?.targets&&t.config?.targets?.filter((e=>e.targets)).length>0)return new Response(JSON.stringify({status:"failure",message:"Please use the latest routes or SDK to use this version of config."}),{status:400,headers:{"content-type":"application/json"}});const r=Le(t.config);if(!r)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});try{return await Ge(e,r,t.params,a,"chatComplete")}catch(e){const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}catch(e){return console.log("chatComplete error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),nt.post("/v1/embed",(async function(e){try{const t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);if(t.config?.targets&&t.config?.targets?.filter((e=>e.targets)).length>0)return new Response(JSON.stringify({status:"failure",message:"Please use the latest routes or SDK to use this version of config."}),{status:400,headers:{"content-type":"application/json"}});let r=Le(t.config);if(!r)return new Response(JSON.stringify({status:"failure",message:"Could not find a provider option."}),{status:400,headers:{"content-type":"application/json"}});try{return await Ge(e,r,t.params,a,"embed")}catch(e){console.error(`embed error: ${e.message}`);const t=JSON.parse(e.message);return new Response(t[t.length-1].errorObj,{status:t[t.length-1].status,headers:{"content-type":"application/json"}})}}catch(e){return new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),nt.post("/v1/chat/completions",ot,tt),nt.post("/v1/completions",ot,at),nt.post("/v1/embeddings",ot,(async function(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const r=Ve(a);return await Fe(e,r,t,a,"embed","POST","config")}catch(e){return console.log("completion error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),nt.post("/v1/images/generations",ot,(async function(e){try{let t=await e.req.json(),a=Object.fromEntries(e.req.raw.headers);const r=Ve(a);return await Fe(e,r,t,a,"imageGenerate","POST","config")}catch(e){return console.log("imageGenerate error",e.message),new Response(JSON.stringify({status:"failure",message:"Something went wrong"}),{status:500,headers:{"content-type":"application/json"}})}})),nt.post("/v1/prompts/*",ot,(e=>e.req.url.endsWith("/v1/chat/completions")?tt(e):e.req.url.endsWith("/v1/completions")?at(e):(e.status(500),e.json({status:"failure",message:"prompt completions error: Something went wrong"})))),nt.post("/v1/proxy/*",Qe),nt.post("/v1/*",ot,Qe),nt.get("/v1/*",ot,et),nt.delete("/v1/*",ot,et);const st=process.argv.slice(2).find((e=>e.startsWith("--port="))),it=st?parseInt(st.split("=")[1]):8787;e({fetch:nt.fetch,port:it}),console.log(`Your AI Gateway is now running on http://localhost:${it} 🚀`);
